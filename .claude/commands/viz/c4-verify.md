# C4 Architecture Verification

Validate the accuracy and completeness of a C4 architecture map.

## Prerequisites

C4 model must exist in `codemap/` folder (generated by `/viz/c4-map`).

Read all codemap files first:
- `codemap/README.md`
- `codemap/level1-context/context.md` and `codemap/level1-context/context.puml`
- `codemap/level2-containers/containers.md` and `codemap/level2-containers/containers.puml`
- `codemap/level3-components/components.md` and `codemap/level3-components/components-*.puml`
- `codemap/level4-code/code.md` and `codemap/level4-code/code-*.puml`

## Instructions

Use the Task tool to spawn 3 parallel Explore subagents in a single message. Each subagent verifies a different aspect.

### Subagent Invocations

**Subagent 1: Completeness Check**
```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Verify C4 completeness"
  prompt: |
    TASK: Verify COMPLETENESS of the C4 map against the actual codebase.

    PREREQUISITE: The codemap/ folder contents have been read. Use that context.

    VERIFICATION GOALS:
    1. Container completeness:
       - Find all deployable units not documented in the map
       - Verify all databases and services are listed
    2. Component completeness:
       - Find all modules not mapped to any component
       - Check for undocumented major directories
    3. Entry point completeness:
       - Find all API routes, CLI commands not documented
    4. External system completeness:
       - Find all external integrations not in context diagram

    SEARCH STRATEGY:
    - Glob for: **/package.json, **/requirements.txt, **/Dockerfile, **/docker-compose.yml
    - List all top-level directories under src/ or equivalent
    - Grep for route definitions: "@app.route", "@router", "app.get(", "app.post("
    - Grep for HTTP clients: "requests.", "httpx.", "axios", "fetch("
    - Grep for SDK imports: "import.*azure", "import.*aws", "from stripe"

    OUTPUT FORMAT:
    Return a completeness report:
    - Missing containers: [list with evidence file paths]
    - Unmapped components: [list with directory paths]
    - Undocumented entry points: [list with file:line references]
    - Missing external systems: [list with import locations]
    - Overall completeness score: X/4 categories complete
```

**Subagent 2: Accuracy Check**
```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Verify C4 accuracy"
  prompt: |
    TASK: Verify ACCURACY of the C4 map against the actual codebase.

    PREREQUISITE: The codemap/ folder contents have been read. Use that context.

    VERIFICATION GOALS:
    1. Relationship accuracy:
       - For each documented relationship, verify it exists in code
       - Check import statements match component dependencies
       - Verify API calls match container relationships
    2. Technology labels:
       - Verify framework versions match package files
       - Check database types match connection code
       - Validate protocol labels (REST, gRPC, WebSocket)
    3. Component boundaries:
       - Verify module boundaries match code organization
       - Find undocumented cross-component dependencies
       - Identify circular dependencies not shown
    4. Naming consistency:
       - Compare diagram names with actual file/folder names
       - Flag outdated or incorrect names

    SEARCH STRATEGY:
    - Read import statements in key files to verify relationships
    - Check package.json/requirements.txt for version numbers
    - Grep for cross-module imports to verify boundaries
    - Compare diagram element names against directory listing

    OUTPUT FORMAT:
    Return an accuracy report:
    - Incorrect relationships: [list with corrections and evidence]
    - Wrong technology labels: [list with correct values]
    - Boundary violations: [list with import evidence]
    - Naming inconsistencies: [list with correct names]
    - Overall accuracy score: X% relationships verified
```

**Subagent 3: Diagram Validation**
```
Tool: Task
Parameters:
  subagent_type: "Explore"
  description: "Validate C4 diagrams"
  prompt: |
    TASK: Verify DIAGRAM QUALITY of the C4 PlantUML files.

    PREREQUISITE: The codemap/ folder contents have been read. Use that context.

    VERIFICATION GOALS:
    1. PlantUML syntax in .puml files:
       - Check all .puml files have valid @startuml/@enduml blocks
       - Verify C4-PlantUML !include statements point to correct URLs:
         - Context: !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
         - Container: !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
         - Component: !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml
       - Verify correct C4 macros are used: Person(), System(), System_Ext(), Container(), ContainerDb(), Component(), Rel()
       - Ensure NO Mermaid syntax (C4Context, C4Container blocks are wrong)
    2. Cross-level consistency:
       - Containers in Level 2 should appear in Level 1 system
       - Components in Level 3 should map to Level 2 containers
       - Classes in Level 4 should map to Level 3 components
    3. Naming conventions:
       - IDs should be consistent across diagrams
       - Labels should be descriptive and concise
       - Relationship labels should describe the interaction
    4. Coverage balance:
       - No single diagram should be overloaded (>15 elements)
       - Important components should have code-level detail
       - Trivial utilities should not have code-level diagrams

    VALIDATION STRATEGY:
    - Read each .puml file and validate syntax
    - Check for @startuml/@enduml blocks
    - Verify !include statements use C4-PlantUML URLs
    - Extract element IDs and cross-reference across levels
    - Count elements per diagram
    - Check for orphaned references

    OUTPUT FORMAT:
    Return a diagram quality report:
    - Syntax errors: [list with file names, line numbers and fixes]
    - Wrong diagram format: [any files using Mermaid instead of PlantUML]
    - Cross-level inconsistencies: [list with missing/orphaned refs]
    - Naming issues: [list with recommendations]
    - Balance recommendations: [diagrams to split or combine]
    - Overall diagram quality score: X/4 criteria met
```

## After All Subagents Complete

### Step 1: Write Verification Report

Consolidate findings into a verification report and write to `codemap/VERIFICATION.md`:

```markdown
# C4 Verification Report

<!-- Verified: YYYY-MM-DD -->

## Completeness
- [ ] All containers identified
- [ ] All major components mapped
- [ ] All entry points documented
- [ ] All external systems listed

### Gaps Found
[Subagent 1 findings]

## Accuracy
- [ ] Relationships verified against code
- [ ] Technology labels correct
- [ ] Component boundaries accurate
- [ ] Names match codebase

### Corrections Needed
[Subagent 2 findings]

## Diagram Quality
- [ ] PlantUML syntax valid
- [ ] Cross-level references aligned
- [ ] Naming consistent
- [ ] Coverage balanced

### Fixes Needed
[Subagent 3 findings]

## Summary
[PASS/FAIL with key issues]

## Corrections Applied
[List of changes made to codemap files]
```

### Step 2: Apply Corrections to Codemap Files

Based on the verification findings, update the codemap files to reflect the current architecture:

**For missing containers/components (from Subagent 1):**
1. Update `codemap/level1-context/context.puml` to add missing external systems
2. Update `codemap/level2-containers/containers.puml` to add missing containers
3. Create new `codemap/level3-components/components-*.puml` files for missing component areas
4. Update corresponding .md documentation files in each level folder

**For accuracy issues (from Subagent 2):**
1. Fix incorrect relationships in .puml files
2. Update technology labels to match actual versions from pyproject.toml/package.json
3. Fix naming inconsistencies between diagram IDs and actual code names
4. Update .md files with corrected information tables

**For diagram quality issues (from Subagent 3):**
1. Fix any PlantUML syntax errors in .puml files
2. Ensure all .puml files use correct C4-PlantUML includes (NOT Mermaid)
3. Standardize element IDs across all diagram levels
4. Split overloaded diagrams into multiple files

### Step 3: Regenerate PNG Exports

After updating any .puml files, regenerate the PNG exports:

```bash
# Regenerate PNGs for all levels
plantuml -tpng codemap/level1-context/*.puml
plantuml -tpng codemap/level2-containers/*.puml
plantuml -tpng codemap/level3-components/*.puml
plantuml -tpng codemap/level4-code/*.puml
```

If PlantUML CLI is not available, note this in the output and provide instructions for manual PNG generation.

### Step 4: Update README

Update `codemap/README.md` with:
- New verification timestamp
- List of corrections applied
- Any new .puml or .png files created

### Step 5: Confirm Output

After all updates are applied, output:

```markdown
# C4 Verification Complete

## Verification Report
Written to: codemap/VERIFICATION.md

## Files Updated
- [ ] codemap/level1-context/context.puml - [changes applied or "no changes"]
- [ ] codemap/level1-context/context.png - [regenerated or "no changes"]
- [ ] codemap/level1-context/context.md - [changes applied or "no changes"]
- [ ] codemap/level2-containers/containers.puml - [changes applied or "no changes"]
- [ ] codemap/level2-containers/containers.png - [regenerated or "no changes"]
- [ ] codemap/level2-containers/containers.md - [changes applied or "no changes"]
- [ ] codemap/level3-components/components-*.puml - [changes applied or "no changes"]
- [ ] codemap/level3-components/components-*.png - [regenerated or "no changes"]
- [ ] codemap/level3-components/components.md - [changes applied or "no changes"]
- [ ] codemap/level4-code/code-*.puml - [changes applied or "no changes"]
- [ ] codemap/level4-code/code-*.png - [regenerated or "no changes"]
- [ ] codemap/level4-code/code.md - [changes applied or "no changes"]

## Summary
- Issues found: X
- Issues fixed: Y
- Manual review needed: Z items

## Render Diagrams
Run the following to regenerate all PNGs:
```bash
plantuml -tpng codemap/level1-context/*.puml
plantuml -tpng codemap/level2-containers/*.puml
plantuml -tpng codemap/level3-components/*.puml
plantuml -tpng codemap/level4-code/*.puml
```
```
